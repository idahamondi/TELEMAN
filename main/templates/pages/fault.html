{% extends '../base.html' %}
{% block content %}
{% load static %}

<nav
    class="flex px-5 py-3 -mt-16 md:-mt-10 mb-2 text-gray-700 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-700 mr-16 lg:mr-24 z-5"
    aria-label="Menu">
    <ol
        class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
		<li class="inline-flex items-center">
            <a
                href="#"
                class="items-center flex justify-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
				<img class="w-6 h-auto inline"
					src="{% static 'images/teleman_icon.png' %}"
					alt="C" />
                <span class="ml-1 text-md font-bold">TELEMAN</span>
            </a>
        </li>
        <li class="inline-flex items-center">
            <a
                href="#"
                class="items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
                <i class="fas fa-desktop"></i>
                Fault
            </a>
        </li>
        <li aria-current="page">
            <div class="flex items-center">
				<i class="fas fa-angle-right"></i>
                <span
                    class="ms-1 ml-2 text-sm font-medium text-gray-500 md:ms-2 dark:text-gray-400"
                    >View</span
                >
            </div>
        </li>
    </ol>
</nav>

{% if user.is_authenticated %}
    {% load user %} {% user user %}
{% endif %}

<div class="container">
    
    {% if fault %}
    {% if location == "global" or fault.fault_id|location_from_fault == location %}

        {% if allow_status == 2 and id == fault.assigned_technician_id %}
            {% if fault.status == "reported" %}
                {% csrf_token %}
                <button type="button" id="fault-resolution-start" class="my-4 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center me-2">
                    <i class="fa fa-eye mr-2 text-lg"></i>
                    <span>Begin Resolution Process</span>
                </button>
                <br/>
                <span class="mb-4 inline-block bg-blue-100 text-blue-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded border border-blue-400">This will set the device under Maintenance</span>
            {% endif %}
            {% if fault.status == "resolution_start" %}
                {% csrf_token %}
                <button type="button" id="fault-resolution-end" class="my-4 text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center me-2">
                    <i class="fa fa-check-circle mr-2 text-lg"></i>
                    <span>Complete Resolution Process</span>
                </button>
                <br/>
                <span class="mb-4 inline-block bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded border border-green-400">The device will be set to Online</span>
            {% endif %}
            {% if fault.status == "resolution_end" %}
                <span class="mb-4 inline-block bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded border border-green-400">Fault Resolved</span>
            {% endif %}
        {% else %}
            {% if fault.status == "reported" %}
                <span class="mb-4 inline-block bg-red-100 text-red-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded border border-red-400">Awaiting Resolution by the Technician</span>
            {% endif %}
            {% if fault.status == "resolution_start" %}
                <span class="mb-4 inline-block bg-blue-100 text-blue-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded border border-blue-400">Device under Maintenance</span>
            {% endif %}
            {% if fault.status == "resolution_end" %}
                <span class="mb-4 inline-block bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded border border-green-400">Fault Resolved</span>
            {% endif %}
        {% endif %}

        <input type="hidden" id="fault-id" name="fault-id" value="{{fault.fault_id}}">
        <input type="hidden" id="reported-user-id" name="reported-user-id" value="{{fault.reported_user_id}}">
        <input type="hidden" id="assigned-technician-id" name="assigned-technician-id" value="{{fault.assigned_technician_id}}">
        <input type="hidden" id="affected-component-id" name="affected-component-id" value="{{fault.affected_component_id}}">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="relative overflow-x-auto">
                <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                    <tbody>
                        <tr class="bg-white dark:bg-gray-800">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                Fault ID
                            </th>
                            <td class="px-6 py-4">
                                {{fault.fault_id}}
                            </td>
                        </tr>
                        <tr class="bg-white dark:bg-gray-800">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                Priority Status
                            </th>
                            <td class="px-6 py-4">
                                {% if fault.priority_level == "high" %}
                                    <span class="bg-red-100 text-red-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded border border-red-400">HIGH</span>
                                {% elif fault.priority_level == "medium" %}
                                    <span class="bg-yellow-100 text-yellow-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded border border-yellow-300">MEDIUM</span>
                                {% elif fault.priority_level == "low" %}
                                    <span class="bg-blue-100 text-blue-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded border border-blue-400">LOW</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr class="bg-white dark:bg-gray-800">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                Status
                            </th>
                            <td class="px-6 py-4">
                                {{fault.status}}
                            </td>
                        </tr>
                        <tr class="bg-white dark:bg-gray-800">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                Date Created
                            </th>
                            <td class="px-6 py-4">
                                {{ fault.date_reported|int_to_time|date:"F j, Y" }} at {{ fault.date_reported|int_to_time|date:"H:i A" }}
                            </td>
                        </tr>
                        <tr class="bg-white dark:bg-gray-800">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                Device Location
                            </th>
                            <td class="px-6 py-4">
                                {{ fault.fault_id|location_from_fault }}
                            </td>
                        </tr>
                        <tr class="bg-white dark:bg-gray-800">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                Device ID
                            </th>
                            <td class="px-6 py-4">
                                {{ fault.affected_component_id }}
                            </td>
                        </tr>
                        <tr class="bg-white dark:bg-gray-800">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                Reported by
                            </th>
                            <td class="px-6 py-4">
                                {% if fault.reported_user_id != None %}
                                    {{ fault.reported_user_id }}
                                {% else %}
                                    {{ fault.assigned_technician_id }}
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="relative bg-white rounded-lg shadow-md p-4">
                <ol class="relative border-s border-gray-700">
                    {% if fault.status == "reported" %}
                        <li class="mb-4 ms-6">
                            <span class="absolute flex items-center justify-center w-6 h-6 bg-red-200 rounded-full -start-3">
                                <span class="absolute flex w-3 h-3 me-3 bg-red-500 rounded-full"></span>
                            </span>
                            <div class="items-center ml-8 justify-between p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:flex">
                                <time class="mb-1 text-xs font-normal text-gray-400 sm:order-last sm:mb-0">{{ fault.date_reported|int_to_time|date:"F j, Y" }} at {{ fault.date_reported|int_to_time|date:"H:i A" }}</time>
                                <div class="text-sm font-normal text-gray-500 dark:text-gray-300">
                                    Device Reported | Fault Log Generated and assigned to Technician <span class="bg-gray-100 text-gray-800 text-xs font-normal me-2 px-2.5 py-0.5 rounded font-semibold text-blue-600">{{ fault.assigned_technician_id }}</span>
                                </div>
                            </div>
                            <h3 class="text-md font-bold text-gray-600">Description</h3>
                            <div class="p-3 text-xs italic font-normal text-gray-500 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-300">
                                {% if fault.description %}
                                    {{ fault.description }}
                                {% else %}
                                    No Description Provided by user
                                {% endif %}
                            </div>
                        </li>
                    {% endif %}
                    {% if fault.status == "resolution_start" %}
                        <li class="mb-4 ms-6">            
                            <span class="absolute flex items-center justify-center w-6 h-6 bg-red-200 rounded-full -start-3">
                                <span class="absolute flex w-3 h-3 me-3 bg-red-500 rounded-full"></span>
                            </span>
                            <div class="items-center ml-8 justify-between p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:flex">
                                <time class="mb-1 text-xs font-normal text-gray-400 sm:order-last sm:mb-0">{{ fault.date_reported|int_to_time|date:"F j, Y" }} at {{ fault.date_reported|int_to_time|date:"H:i A" }}</time>
                                <div class="text-sm font-normal text-gray-500 dark:text-gray-300">
                                    Device Reported | Fault Log Generated and assigned to Technician <span class="bg-gray-100 text-gray-800 text-xs font-normal me-2 px-2.5 py-0.5 rounded font-semibold text-blue-600">{{ fault.assigned_technician_id }}</span>
                                </div>
                            </div>
                            <h3 class="text-md font-bold text-gray-600">Description</h3>
                            <div class="p-3 text-xs italic font-normal text-gray-500 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-300">
                                {% if fault.description %}
                                    {{ fault.description }}
                                {% else %}
                                    No Description Provided by user
                                {% endif %}
                            </div>
                        </li>
                        <li class="mb-4 ms-6">
                            <span class="absolute flex items-center justify-center w-6 h-6 bg-blue-200 rounded-full -start-3">
                                <span class="flex w-3 h-3 me-3 bg-blue-600 rounded-full"></span>
                            </span>
                            <div class="p-4 bg-white ml-8 border border-gray-200 rounded-lg shadow-sm">
                                <div class="items-center justify-between mb-3 sm:flex">
                                    <time class="mb-1 text-xs font-normal text-gray-400 sm:order-last sm:mb-0">{{ fault.resolution_start_time|int_to_time|date:"F j, Y" }} at {{ fault.resolution_start_time|int_to_time|date:"H:i A" }}</time>
                                    <div class="text-sm font-normal text-gray-500 lex dark:text-gray-300">
                                        Resolution Process Started - <span class="font-semibold text-gray-900 dark:text-white">DEVICE UNDER </span> <span class="font-bold text-yellow-400 dark:text-white">MAINTENANCE</span>
                                    </div>
                                </div>
                            </div>
                        </li>
                    {% endif %}
                    {% if fault.status == "resolution_end" %}
                        <li class="mb-4 ms-6">            
                            <span class="absolute flex items-center justify-center w-6 h-6 bg-red-200 rounded-full -start-3">
                                <span class="absolute flex w-3 h-3 me-3 bg-red-500 rounded-full"></span>
                            </span>
                            <div class="items-center ml-8 justify-between p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:flex">
                                <time class="mb-1 text-xs font-normal text-gray-400 sm:order-last sm:mb-0">{{ fault.date_reported|int_to_time|date:"F j, Y" }} at {{ fault.date_reported|int_to_time|date:"H:i A" }}</time>
                                <div class="text-sm font-normal text-gray-500 dark:text-gray-300">
                                    Device Reported | Fault Log Generated and assigned to Technician <span class="bg-gray-100 text-gray-800 text-xs font-normal me-2 px-2.5 py-0.5 rounded font-semibold text-blue-600">{{ fault.assigned_technician_id }}</span>
                                </div>
                            </div>
                            <h3 class="text-md font-bold text-gray-600">Description</h3>
                            <div class="p-3 text-xs italic font-normal text-gray-500 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-300">
                                {% if fault.description %}
                                    {{ fault.description }}
                                {% else %}
                                    No Description Provided by user
                                {% endif %}
                            </div>
                        </li>
                        <li class="mb-4 ms-6">
                            <span class="absolute flex items-center justify-center w-6 h-6 bg-blue-200 rounded-full -start-3">
                                <span class="flex w-3 h-3 me-3 bg-blue-600 rounded-full"></span>
                            </span>
                            <div class="p-4 bg-white ml-8 border border-gray-200 rounded-lg shadow-sm">
                                <div class="items-center justify-between mb-3 sm:flex">
                                    <time class="mb-1 text-xs font-normal text-gray-400 sm:order-last sm:mb-0">{{ fault.resolution_start_time|int_to_time|date:"F j, Y" }} at {{ fault.resolution_start_time|int_to_time|date:"H:i A" }}</time>
                                    <div class="text-sm font-normal text-gray-500 lex dark:text-gray-300">
                                        Resolution Process Started - <span class="font-semibold text-gray-900 dark:text-white">DEVICE UNDER </span> <span class="font-bold text-yellow-400 dark:text-white">MAINTENANCE</span>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="ms-6">
                            <span class="absolute flex items-center justify-center w-6 h-6 bg-green-200 rounded-full -start-3">
                                <span class="flex w-3 h-3 me-3 bg-green-500 rounded-full"></span>
                            </span>
                            <div class="items-center ml-8 justify-between p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:flex">
                                <time class="mb-1 text-xs font-normal text-gray-400 sm:order-last sm:mb-0">{{ fault.resolution_end_time|int_to_time|date:"F j, Y" }} at {{ fault.resolution_end_time|int_to_time|date:"H:i A" }}</time>
                                <div class="text-sm font-normal text-gray-500 lex dark:text-gray-300">
                                    Resolution Process Completed - <span class="font-semibold text-gray-900 dark:text-white">DEVICE BACK</span> <span class="font-bold text-green-400 dark:text-white">ONLINE</span>
                                </div>
                            </div>
                        </li>
                    {% endif %}
                </ol>
            </div>
        </div>

    {% else %}
        UNAUTHORIZED ACCESS! ONLY ACCESSIBLE TO Users in {{ fault.fault_id|location_from_fault }}
    {% endif %}
    {% else %}
        FAULT ID NOT FOUND
    {% endif %}
	
</div>

{% if user.is_authenticated %}
    {% load notifications %}
    {% notifications user %}
{% endif %}

<script type="text/javascript">
    $(document).ready(function (e) {
        $('#fault-resolution-start').on('click', function(){
            var form_data = new FormData();

            csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
            fault_id = $('#fault-id').val();
            assigned_technician_id = $('#assigned-technician-id').val();
            affected_component_id = $('#affected-component-id').val();
            reported_user_id = $('#reported-user-id').val();

            form_data.append("csrfmiddlewaretoken", csrf_token);
            form_data.append("fault_id", fault_id);
            form_data.append("reported_user_id", reported_user_id);
            form_data.append("assigned_technician_id", assigned_technician_id);
            form_data.append("affected_component_id", affected_component_id);
            form_data.append("status", "resolution_start");
            form_data.append("resolution_time", "resolution_start_time");
            form_data.append("availability", 0);

            let self = $(this)
            self.attr({disabled: 'disabled'})
            self.children('i').removeClass('fa-eye')
            self.children('i').addClass('fa-spinner fa-spin')

            setTimeout(() => {
                $.ajax({
                    url: '/update_fault/',
                    dataType: 'json',
                    cache: false,
                    contentType: false,
                    processData: false,
                    data: form_data,
                    type: 'post',
                    success: function (response) {
                        self.children('i').removeClass('fa-spinner fa-spin')
                        self.children('i').addClass('fa-check')
                        self.children('span').text('Resolution Process Started')
                        setTimeout(() => {
                            window.location = window.location;
                        }, 2000)
                    },
                    error: function (response) {
                        console.log(response);
                    }
                })
            }, 2000)
        })
        $('#fault-resolution-end').on('click', function(){
            var form_data = new FormData();

            csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
            fault_id = $('#fault-id').val();
            assigned_technician_id = $('#assigned-technician-id').val();
            affected_component_id = $('#affected-component-id').val();
            reported_user_id = $('#reported-user-id').val();

            form_data.append("csrfmiddlewaretoken", csrf_token);
            form_data.append("fault_id", fault_id);
            form_data.append("reported_user_id", reported_user_id);
            form_data.append("assigned_technician_id", assigned_technician_id);
            form_data.append("affected_component_id", affected_component_id);
            form_data.append("status", "resolution_end");
            form_data.append("resolution_time", "resolution_end_time");
            form_data.append("availability", 1);

            let self = $(this)
            self.attr({disabled: 'disabled'})
            self.children('i').removeClass('fa-eye')
            self.children('i').addClass('fa-spinner fa-spin')

            setTimeout(() => {
                $.ajax({
                    url: '/update_fault/',
                    dataType: 'json',
                    cache: false,
                    contentType: false,
                    processData: false,
                    data: form_data,
                    type: 'post',
                    success: function (response) {
                        self.children('i').removeClass('fa-spinner fa-spin')
                        self.children('i').addClass('fa-check')
                        self.children('span').text('Resolution Process Completed')
                        setTimeout(() => {
                            window.location = window.location;
                        }, 2000)
                    },
                    error: function (response) {
                        console.log(response);
                    }
                })
            }, 2000)
        })
    });
</script>

{% endblock content %}